<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iframe с внутренним fetch запросом</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background-color: #45a049;
        }

        #iframe-container {
            margin-top: 20px;
        }

        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Iframe с fetch запросом внутри</h1>
        <button id="loadBtn">Создать iframe с запросом</button>
        <div id="iframe-container"></div>
    </div>

    <script>
        (function () {
            document.getElementById('loadBtn').addEventListener('click', function () {

                // HTML контент для iframe с IIFE и fetch запросом внутри
                const iframeContent = `
                    <!DOCTYPE html>
                    <html lang="ru">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                padding: 20px;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                min-height: 100vh;
                                margin: 0;
                            }
                            .content {
                                background: white;
                                padding: 20px;
                                border-radius: 8px;
                                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            }
                            .loading {
                                text-align: center;
                                color: #666;
                                font-size: 18px;
                                padding: 40px;
                            }
                            .spinner {
                                border: 4px solid #f3f3f3;
                                border-top: 4px solid #667eea;
                                border-radius: 50%;
                                width: 40px;
                                height: 40px;
                                animation: spin 1s linear infinite;
                                margin: 20px auto;
                            }
                            @keyframes spin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                            .data-card {
                                background: #f8f9fa;
                                padding: 15px;
                                margin: 10px 0;
                                border-radius: 6px;
                                border-left: 4px solid #667eea;
                            }
                            .data-card h3 {
                                margin: 0 0 10px 0;
                                color: #333;
                            }
                            .data-card p {
                                margin: 5px 0;
                                color: #666;
                                line-height: 1.6;
                            }
                            .error {
                                color: #d32f2f;
                                background: #ffebee;
                                padding: 15px;
                                border-radius: 6px;
                                border-left: 4px solid #d32f2f;
                            }
                            .success {
                                color: #2e7d32;
                                background: #e8f5e9;
                                padding: 10px;
                                border-radius: 6px;
                                margin-bottom: 15px;
                            }
                            button {
                                background: #667eea;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 14px;
                                margin: 5px;
                            }
                            button:hover {
                                background: #5568d3;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="content">
                            <div id="result">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>Загрузка данных из API...</p>
                                </div>
                            </div>
                            <div style="margin-top: 20px; text-align: center;">
                                <button id="reloadBtn">Загрузить другие данные</button>
                                <button id="loadUsersBtn">Загрузить пользователей</button>
                            </div>
                        </div>

                        <script>
                            // IIFE - выполняется сразу при загрузке iframe
                            (async function() {
                                const resultDiv = document.getElementById('result');
                                
                                // Функция для загрузки постов
                                async function loadPosts() {
                                    resultDiv.innerHTML = \`
                                        <div class="loading">
                                            <div class="spinner"></div>
                                            <p>Загрузка постов...</p>
                                        </div>
                                    \`;
                                    
                                    try {
                                        // Fetch запрос к внешнему API
                                        const response = await fetch('https://jsonplaceholder.typicode.com/posts?_limit=5');
                                        
                                        if (!response.ok) {
                                            throw new Error('Ошибка сети: ' + response.status);
                                        }
                                        
                                        const posts = await response.json();
                                        
                                        // Отображаем полученные данные
                                        let html = '<div class="success">✓ Данные успешно загружены из API!</div>';
                                        html += '<h2>Последние посты:</h2>';
                                        
                                        posts.forEach(post => {
                                            html += \`
                                                <div class="data-card">
                                                    <h3>\${post.title}</h3>
                                                    <p><strong>ID:</strong> \${post.id} | <strong>User ID:</strong> \${post.userId}</p>
                                                    <p>\${post.body}</p>
                                                </div>
                                            \`;
                                        });
                                        
                                        resultDiv.innerHTML = html;
                                        
                                        // Отправляем сообщение родительскому окну
                                        window.parent.postMessage({
                                            type: 'iframe:data-loaded',
                                            count: posts.length
                                        }, '*');
                                        
                                    } catch (error) {
                                        resultDiv.innerHTML = \`
                                            <div class="error">
                                                <strong>Ошибка при загрузке данных:</strong><br>
                                                \${error.message}
                                            </div>
                                        \`;
                                        console.error('Ошибка:', error);
                                    }
                                }
                                
                                // Функция для загрузки пользователей
                                async function loadUsers() {
                                    resultDiv.innerHTML = \`
                                        <div class="loading">
                                            <div class="spinner"></div>
                                            <p>Загрузка пользователей...</p>
                                        </div>
                                    \`;
                                    
                                    try {
                                        const response = await fetch('https://jsonplaceholder.typicode.com/users?_limit=5');
                                        
                                        if (!response.ok) {
                                            throw new Error('Ошибка сети: ' + response.status);
                                        }
                                        
                                        const users = await response.json();
                                        
                                        let html = '<div class="success">✓ Пользователи загружены!</div>';
                                        html += '<h2>Список пользователей:</h2>';
                                        
                                        users.forEach(user => {
                                            html += \`
                                                <div class="data-card">
                                                    <h3>\${user.name}</h3>
                                                    <p><strong>Email:</strong> \${user.email}</p>
                                                    <p><strong>Телефон:</strong> \${user.phone}</p>
                                                    <p><strong>Сайт:</strong> \${user.website}</p>
                                                    <p><strong>Компания:</strong> \${user.company.name}</p>
                                                </div>
                                            \`;
                                        });
                                        
                                        resultDiv.innerHTML = html;
                                        
                                    } catch (error) {
                                        resultDiv.innerHTML = \`
                                            <div class="error">
                                                <strong>Ошибка:</strong> \${error.message}
                                            </div>
                                        \`;
                                    }
                                }
                                
                                // Загружаем посты при первой загрузке
                                await loadPosts();
                                
                                // Обработчики кнопок
                                document.getElementById('reloadBtn').addEventListener('click', loadPosts);
                                document.getElementById('loadUsersBtn').addEventListener('click', loadUsers);
                                
                            })();
                        <\/script>
                    </body>
                    </html>
                `;

                // Создаём iframe
                const iframe = document.createElement('iframe');
                iframe.srcdoc = iframeContent;

                // Очищаем контейнер и добавляем iframe
                const container = document.getElementById('iframe-container');
                container.innerHTML = '';
                container.appendChild(iframe);

                // Слушаем сообщения от iframe
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'iframe:data-loaded') {
                        console.log('Iframe загрузил данные! Количество:', event.data.count);
                    }
                });

                this.disabled = true;
                this.textContent = 'Iframe создан';
            });
        })();
    </script>
</body>

</html>